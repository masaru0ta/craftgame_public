---
name: tdd-workflow
description: テスト駆動開発ワークフロー。新機能実装、バグ修正、リファクタリング時に適用
---

# TDD ワークフロー

このプロジェクトではテスト駆動開発（TDD）を採用する。

## 適用タイミング

以下の作業時にこのワークフローを適用する：
- 新機能の実装
- バグ修正
- 既存機能のリファクタリング

## 基本サイクル

1. **RED** - 失敗するテストを先に書く
2. **GREEN** - テストをパスする最小限の実装
3. **REFACTOR** - コードを整理（テストは常にパス維持）

## 実装手順

### 1. 仕様書の確認
- `docs/spec_*.md` から対象機能の仕様を把握
- テスト観点を確認


### 2. テストコード作成
- `tests/spec_*_*.spec.js` にPlaywrightテストを作成
- テスト項目は仕様書のテスト観点に基づき、仕様の記述を１つずつテストコードにする
- 正常系と異常系の両方を洗い出す
- playwrightでの検証が困難なテスト内容は検証可能な内容に置き換える
- **各テストは独立して実行可能にする**（他のテストに依存しない）
- 実装前にテストを実行し、失敗することを確認

#### 2.1 仕様をテスト可能な内容に変換
見え方に関する内容はplaywrightでは検証が困難なため、検証可能な内容に置き換えてテストコードを作成する
| 確認したい仕様 | テスト内容 |
|---|---|
| 要素の表示 | その要素が存在するか |
| 要素の回転 | 角度変数を参照して確認 |
| 正方形かどうか | 要素のサイズを取得して確認 |
| テクスチャが正しいか | コードに＊＊の実装があるか |

### 3. 実装
- テストをパスする最小限のコードを書く
- 過剰な実装をしない

### 4. テスト実行・修正
- 全テストがパスするまで修正を繰り返す
- 新しいテストを追加したら、そのテストが失敗することを確認してから実装

### 5. コミット
- 全テストがパスした状態でのみコミット

## テストコマンド

| コマンド                  | 用途                               |
|--------------------------|------------------------------------|
| `npm run test:quiet`     | 通常実行（軽量出力、コンテキスト節約） |
| `npm run test`           | 詳細出力付き実行                     |
| `npm run test:ui`        | UIモードで確認                       |
| `npm run test:headed`    | ブラウザ表示付き実行                 |

## テスト結果の確認

- `npx playwright test --config=tests/playwright.config.js --list` - テスト項目一覧
- `tests/playwright-report/index.html` - HTMLレポート

## 避けるべきミス

| アンチパターン              | 正しいアプローチ                      |
|----------------------------|-------------------------------------|
| 実装の詳細をテストする        | ユーザーから見える振る舞いをテストする   |
| HTML構造に依存したセレクタ    | テキストや役割で要素を取得              |
| テスト間で状態を共有する      | 各テストで独立したセットアップを行う     |
| テストコードと実装を同時に修正 | どちらか一方ずつ修正（原因特定のため）   |

## 注意事項

- テストが全件パスするまでコミットしない
- 実装前に必ず仕様書を確認する
- 1つの機能の実装とテストが完了してからプルリクエストを作成
