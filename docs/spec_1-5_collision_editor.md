# 仕様書: 1-5 カスタムブロック当たり判定エディタ

## 1. 概要

1-4 で作った CustomBlockEditor に、当たり判定を編集する機能と当たり判定チェック機能を追加する。
当たり判定データは 4x4x4 のグリッドで編集する。
当たり判定チェック機能では、上部から多量のボールが落ちてくる。

ここで作る重要な部品は、
- カスタムブロックの当たり判定ライブラリ（ゲーム本体で利用）
- CollisionChecker クラス（BlockEditorUI で利用）
- CustomBlockEditor への当たり判定編集機能追加

src/test/ 及び src/game/ のディレクトリは公開用の Github リポジトリにプッシュする
公開用リポジトリ: https://github.com/masaru0ta/craftgame_public

## 2. 関連資料

- spec_1-1_block_data_sheet.md: データ構造
- spec_1-4_custom_block_editor.md: カスタムブロックエディタ（見た目編集）
- spec_1-6_block_shape_manager.md: BlockEditorUI（このクラスを利用する）

## 3. アーキテクチャ

### 3.1 クラス構成

```
BlockEditorUI (1-6で定義)
    └── CustomBlockEditor (1-4で定義)
        ├── CustomBlockMeshBuilder
        ├── VoxelCollision (当たり判定データライブラリ)
        └── CollisionChecker (このクラス、衝突テスト用)
```

### 3.2 責務分離

| クラス | 責務 |
|--------|------|
| CustomBlockEditor | 当たり判定編集モード、当たり判定ボクセル表示 |
| VoxelCollision | 当たり判定データのエンコード/デコード |
| CollisionChecker | 衝突テストのボール物理演算（独立クラス） |
| BlockEditorUI | UI生成、衝突テスト開始/停止の制御 |

## 4. 機能詳細

### 4.1 CustomBlockEditor 拡張メソッド

1-4 で定義したメソッドに加え、以下を追加:

| メソッド | 説明 |
|----------|------|
| `setEditMode(mode)` | 編集モード('look' or 'collision')を設定 |
| `getEditMode()` | 現在の編集モードを取得 |
| `getVoxelCollisionData()` | 当たり判定ボクセルデータを取得（Base64） |
| `autoCreateCollision()` | 見た目から当たり判定を自動生成 |

### 4.2 CollisionChecker クラス

#### コンストラクタ

```javascript
constructor(options) {
  // options.THREE: Three.jsライブラリ
  // options.scene: Three.jsシーン（ボールを追加する対象）
  // options.camera: Three.jsカメラ（重力方向の計算用）
}
```

#### 公開メソッド

| メソッド | 説明 |
|----------|------|
| `setCollisionData(data)` | 4x4x4の当たり判定データを設定 |
| `start()` | 衝突テストを開始（ボール生成、アニメーション開始） |
| `stop()` | 衝突テストを停止（ボール削除） |
| `dispose()` | リソース解放 |

### 4.3 編集モード切替

CustomBlockEditor は2つの編集モードをサポート:

| モード | グリッドサイズ | ブラシサイズ | 表示内容 |
|--------|---------------|-------------|----------|
| look（見た目） | 8x8x8 | 1x, 2x, 4x 選択可 | ボクセルメッシュ |
| collision（当たり判定） | 4x4x4 | 2x 固定 | 白いボクセル |

モード切替時:
- 見た目モード: ボクセルメッシュを表示、当たり判定メッシュを非表示
- 当たり判定モード: ボクセルメッシュを非表示、当たり判定メッシュ（白いボクセル）を表示

### 4.4 当たり判定編集

- 見た目編集と同様の操作で、当たり判定のボクセルを編集できる
- ハイライトサイズは見た目の2x2x2ボクセルに相当（当たり判定1ボクセル分）
- 右クリックで当たり判定ボクセルを配置
- 左クリックで当たり判定ボクセルを削除

### 4.5 自動作成機能

`autoCreateCollision()` を呼び出すと:
- 見た目の2x2x2ボクセル領域に1つでもボクセルがあれば、対応する当たり判定ボクセルを1（衝突あり）に設定
- 見た目の2x2x2ボクセル領域が全て空の場合、対応する当たり判定ボクセルを0（通過可）に設定
- 既存の当たり判定データは上書きされる

### 4.6 衝突テスト

CollisionChecker の動作仕様:

- 小さな球体（直径0.1ブロック相当）が上空から落ちてくる
- 同時に30個の球体が存在
- 球体が画面外に落ちたら消え、新しい球体が上空から生成される（継続的に落下）
- 当たり判定ボクセルとの衝突でボールが反射する
- 重力シミュレーション（当たり判定が無い場所では落下）
- 重力方向は常に画面の下方向（カメラの向きに追従）
- 物理演算は60fps固定タイムステップで実行

### 4.7 データ形式

#### voxel_collision形式（4x4x4、1bit）
- 各ボクセルは1ビット（0-1）で表現
  - 0: 通過可（空気）
  - 1: 衝突あり（ソリッド）
- データはY→Z→X順で格納
- Base64エンコードして保存
- 総データサイズ: 4x4x4 = 64ボクセル * 1bit = 64bit = 8bytes

## 5. ファイル構成

```
src/
  game/
    custom_collision_checker.js  # 衝突テストチェッカー
    custom_collision.js          # カスタムブロック当たり判定データライブラリ
```

※ custom_block_editor.js は 1-4 で作成済み、当たり判定編集機能を追加

## 6. 補足仕様

### 6.1 初期状態
- 新規ブロック作成時、または `voxel_collision` が空のブロックを選択した場合、当たり判定は全て0（通過可）で開始

### 6.2 見た目との対応
- 当たり判定の1ボクセル = 見た目の2x2x2ボクセルに対応
- 当たり判定座標(x,y,z) は 見た目座標(x*2, y*2, z*2)〜(x*2+1, y*2+1, z*2+1) に対応

### 6.3 編集範囲の制限
- 4x4x4の範囲外にボクセルを配置しようとした場合は無視する

### 6.4 空の状態での保存
- 当たり判定が0個（全て通過可）の状態でも保存を許可する

### 6.5 保存の動作
- 保存時は見た目（voxel_look）と当たり判定（voxel_collision）を同時に保存する

## 7. 実装詳細: ボクセル表示

### 7.1 面ごとの明るさ

ボクセルの視認性向上のため、面ごとに異なる明るさを適用する。

| 面 | 明るさ |
|---|---|
| +Y (上面) | 1.0 (最も明るい) |
| +Z, -Z (前後) | 0.85 |
| +X, -X (左右) | 0.75 |
| -Y (底面) | 0.5 (最も暗い) |

- `MeshBasicMaterial` と頂点カラーを使用（ライティングの影響を受けない）
- 見た目ボクセル、当たり判定ボクセルの両方に適用

### 7.2 当たり判定ボクセル表示仕様

- 色: 白色（#FFFFFF）× 面ごとの明るさ
- サイズ: ブロック全体を1として各当たり判定は1/4
- 当たり判定モード時は見た目メッシュを非表示にし、当たり判定ボクセルのみ表示

## 8. 実装上の注意点

### 8.1 座標系の違いに注意

見た目編集モードと当たり判定編集モードでは座標系が異なる：

| モード | グリッドサイズ | ボクセルサイズ |
|--------|---------------|---------------|
| 見た目編集 | 8x8x8 | 1/8 |
| 当たり判定編集 | 4x4x4 | 1/4 |

### 8.2 highlightedVoxel/highlightedFace の座標系

`showVoxelHighlight()` および `showFloorHighlight()` では、**モードに応じた座標系**で `highlightedVoxel` および `highlightedFace` を設定する。

- 見た目モード: 8x8x8 座標系（0-7）
- 当たり判定モード: 4x4x4 座標系（0-3）

### 8.3 配置・削除処理での座標変換は不要

**重要**: `placeCollisionVoxel()` および `deleteCollisionVoxel()` では、`highlightedVoxel` と `highlightedFace` が**既に4x4座標系で設定されている**ため、座標変換を行ってはならない。

### 8.4 レイキャスト対象の切り替え

`updateHighlight()` では、モードに応じてレイキャスト対象を切り替える。

## 9. テスト項目

### CustomBlockEditor 当たり判定編集

- [ ] `setEditMode('collision')` で当たり判定編集モードに切り替わる
- [ ] `setEditMode('look')` で見た目編集モードに切り替わる
- [ ] `getEditMode()` で現在のモードが取得できる
- [ ] 当たり判定モードで床面グリッドが4x4で表示される
- [ ] 当たり判定ボクセル（4x4x4）が白色で表示される
- [ ] 当たり判定モード時は見た目メッシュが非表示になる
- [ ] 右クリックで当たり判定ボクセルを配置できる
- [ ] 左クリックで当たり判定ボクセルを削除できる
- [ ] 配置・削除が即座に白いボクセル表示に反映される
- [ ] 4x4x4の範囲外には配置できない

### 自動作成機能

- [ ] `autoCreateCollision()` で見た目データから当たり判定が自動生成される
- [ ] 見た目の2x2x2領域に1つでもボクセルがあれば対応する当たり判定が1になる
- [ ] 見た目の2x2x2領域が全て空なら対応する当たり判定が0になる

### CollisionChecker クラス

- [ ] `setCollisionData(data)` で当たり判定データを設定できる
- [ ] `start()` でボールが生成されアニメーションが開始される
- [ ] `stop()` でボールが削除されアニメーションが停止する
- [ ] 同時に30個の球体が存在する
- [ ] 球体に重力が適用され落下する
- [ ] 当たり判定ボクセルとの衝突で球体が反射する
- [ ] 当たり判定が無い場所では球体がそのまま落下する
- [ ] 物理演算が60fps固定で実行される
- [ ] `dispose()` でリソースが解放される

### データエンコード/デコード

- [ ] `getVoxelCollisionData()` でBase64エンコードされたデータが取得できる
- [ ] 当たり判定が0個（全て通過可）の状態でも取得できる
