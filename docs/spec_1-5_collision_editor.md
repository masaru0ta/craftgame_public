# 仕様書: 1-5 カスタムブロック当たり判定エディタ

## 1. 概要

1-4 で作ったカスタムブロックエディタに、当たり判定を編集する機能と当たり判定チェック機能を追加する。
当たり判定データは 4x4x4 のグリッドで編集する。
当たり判定チェック機能では、上部から多量のボールが落ちてくる。

ここで作る重要な部品は、
- カスタムブロックの当たり判定ライブラリ（ゲーム本体で利用）
- 当たり判定の編集UI（管理ツールで利用）

src/test/ 及び src/game/ のディレクトリは公開用の Github リポジトリにプッシュする
公開用リポジトリ: https://github.com/masaru0ta/craftgame_public

## 2. 関連資料

- spec_1-1_block_data_sheet.md: データ構造
- spec_1-4_custom_block_editor.md: カスタムブロックエディタ（見た目編集）
- src/game/custom_block_editor.js
- src/game/voxel_data.js

## 3. 機能詳細

### 3.1 画面構成

- カスタムブロックエディタの 3Dプレビュー内だけ変更する。

### 3.2 3Dプレビュー変更点

- ツールボタン枠の左端に、見た目・当たり判定の切り換えボタンを設置
- 見た目編集モードの時は当たり判定の形状を表示しない
- 当たり判定編集モードの時は見た目の形状を表示せず、当たり判定の形状を白いボクセルで表示
- 切り換えボタン内にはミニチュア3Dプレビューで今編集していない方の形状を表示
- 当たり判定編集モード時:
  - ブラシサイズ切り替えボタンが [2x] 固定になり、他はグレーアウト
  - 床面のグリッド線は 4x4
  - 下部のコントロール枠にはマテリアル選択の代わりに「簡易チェック」ボタンを配置
- 見た目編集モード時:
  - 1-4と同じ動作（ブラシサイズ選択可、グリッド8x8、マテリアル選択）

### 3.2.4 当たり判定編集

- 見た目編集と同様の操作で、当たり判定のボクセルを編集できる

### 3.2.5 操作方法

#### PC（マウス操作）

| 操作 | 動作 |
|------|------|
| 左ドラッグ | 視点回転 |
| 左クリック | ボクセル削除 |
| 右クリック | ボクセル配置 |
| マウスホイール | ズーム |

#### スマートフォン（タッチ操作）

| 操作 | 動作 |
|------|------|
| 1本指ドラッグ | 視点回転 |
| タップ（短くタッチ） | ボクセル削除 |
| ロングプレス（500ms長押し） | ボクセル配置 |
| 2本指ピンチ | ズーム |

- ロングプレスで配置する際、対応デバイスでは振動フィードバックがある

### 3.3 簡易チェック機能

下部コントロール枠の「簡易チェック」ボタンをクリックすると、簡易チェックモードに切り替わる。

#### 3.3.1 簡易チェックモード

- 小さな球体（直径0.15ブロック相当）が上空から落ちてくる
- 同時に30個の球体が存在
- 球体が画面外に落ちたら消え、新しい球体が上空から生成される（継続的に落下）
- 当たり判定ボクセルとの衝突でボールが反射する
- 重力シミュレーション（当たり判定が無い場所では落下）
- 重力方向は常に画面の下方向（カメラの向きに追従）

### 3.4 データ形式

#### voxel_collision形式（4x4x4、1bit）
- 各ボクセルは1ビット（0-1）で表現
  - 0: 通過可（空気）
  - 1: 衝突あり（ソリッド）
- データはY→Z→X順で格納
- Base64エンコードして保存
- 総データサイズ: 4x4x4 = 64ボクセル * 1bit = 64bit = 8bytes

## 4. ファイル構成

```
src/
  game/
    custom_collision_checker.js  # 簡易当たり判定チェッカー
    custom_collision.js          # カスタムブロック当たり判定ライブラリ
```

## 5. 補足仕様

### 5.1 初期状態
- 新規ブロック作成時、または `voxel_collision` が空のブロックを選択した場合、当たり判定は全て0（通過可）で開始

### 5.2 見た目との対応
- 当たり判定の1ボクセル = 見た目の2x2x2ボクセルに対応
- 当たり判定座標(x,y,z) は 見た目座標(x*2, y*2, z*2)〜(x*2+1, y*2+1, z*2+1) に対応

### 5.3 編集範囲の制限
- 4x4x4の範囲外にボクセルを配置しようとした場合は無視する

### 5.4 Undo/Redo機能
- 本仕様では実装しない

### 5.5 空の状態での保存
- 当たり判定が0個（全て通過可）の状態でも保存を許可する

### 5.6 保存の動作
- 保存ボタンは1つで、見た目（voxel_look）と当たり判定（voxel_collision）を同時に保存する

### 5.7 カスタムブロック以外
- shape_type="normal" のブロックを選択した場合は編集不可とし、警告メッセージを表示

## 6. 実装詳細: 当たり判定ボクセル表示

### 6.1 概要

当たり判定ボクセルは、白いボクセル（MeshStandardMaterial）で表示する。

### 6.2 表示仕様

- 色: 白色（#FFFFFF）
- サイズ: ブロック全体を1として各当たり判定は1/4
- 当たり判定モード時は見た目メッシュを非表示にし、当たり判定ボクセルのみ表示

### 6.3 Three.js実装例

```javascript
const collisionSize = 1 / 4; // ブロック全体を1として各当たり判定は1/4
const geometry = new THREE.BoxGeometry(collisionSize, collisionSize, collisionSize);
const material = new THREE.MeshStandardMaterial({ color: 0xffffff });
const mesh = new THREE.Mesh(geometry, material);
```

## 9. 実装上の注意点

### 9.1 座標系の違いに注意

見た目編集モードと当たり判定編集モードでは座標系が異なる：

| モード | グリッドサイズ | ボクセルサイズ |
|--------|---------------|---------------|
| 見た目編集 | 8x8x8 | 1/8 |
| 当たり判定編集 | 4x4x4 | 1/4 |

### 9.2 highlightedVoxel/highlightedFace の座標系

`showVoxelHighlight()` および `showFloorHighlight()` では、**モードに応じた座標系**で `highlightedVoxel` および `highlightedFace` を設定する。

- 見た目モード: 8x8x8 座標系（0-7）
- 当たり判定モード: 4x4x4 座標系（0-3）

### 9.3 配置・削除処理での座標変換は不要

**重要**: `placeCollisionVoxel()` および `deleteCollisionVoxel()` では、`highlightedVoxel` と `highlightedFace` が**既に4x4座標系で設定されている**ため、座標変換（`/2` など）を行ってはならない。

```javascript
// 正しい実装
deleteCollisionVoxel() {
  const { x, y, z } = this.highlightedVoxel; // 既に4x4座標系
  VoxelCollision.set(this.collisionData, x, y, z, 0);
}

// 誤った実装（座標がずれる）
deleteCollisionVoxel() {
  const collX = Math.floor(this.highlightedVoxel.x / 2); // 不要な変換
  VoxelCollision.set(this.collisionData, collX, ...);
}
```

### 9.4 レイキャスト対象の切り替え

`updateHighlight()` では、モードに応じてレイキャスト対象を切り替える：

```javascript
const targetMesh = this.editMode === 'collision' ? this.collisionMesh : this.blockMesh;
const intersects = this.raycaster.intersectObjects(targetMesh.children, false);
```

## 7. テスト用CSSセレクタ定義

| 要素 | セレクタ | 検証内容 |
|------|----------|----------|
| 右カラム | `.right-column` | 全幅の基準 |
| 3Dプレビュー枠 | `.preview-container` | アスペクト比 3:4 |
| ツールボタン枠 | `.toolbar` | 高さ 1/8 |
| 3Dプレビュー領域 | `.preview-3d` | 高さ 6/8 |
| コントロール枠 | `.control-panel` | 高さ 1/8 |
| モード切替ボタン | `.mode-toggle-btn` | 見た目/当たり判定切り替え |
| ブラシサイズボタン | `.brush-size-btn` | 3つ存在（当たり判定モード時は[2x]以外グレーアウト） |
| 簡易チェックボタン | `.check-btn` | 1つ存在 |
| 背景色表示 | `.bg-color-indicator` | 背景色の確認 |

## 8. テスト項目

※ 画面表示、レイアウト、カメラ操作、GAS API連携などは 1-4 でテスト済み

### モード切替ボタン
- [ ] ツールボタン枠左端にモード切替ボタンが表示される
- [ ] モード切替ボタンクリックで見た目編集モードと当たり判定編集モードが切り替わる
- [ ] 見た目モード時はボタンに当たり判定の形状（白いボクセル）が表示される
- [ ] 当たり判定モード時はボタンに見た目の形状（メッシュ）が表示される

### 当たり判定モード表示
- [ ] 当たり判定編集モードでは床面グリッドが4x4で表示される
- [ ] 当たり判定ボクセル（4x4x4）が白色で表示される
- [ ] 当たり判定モード時は見た目メッシュが非表示になる
- [ ] 当たり判定モード時は [2x] 以外のブラシサイズボタンがグレーアウトされる
- [ ] コントロール枠に「簡易チェック」ボタンが表示される

### 当たり判定編集
- [ ] ハイライトサイズは見た目の2x2x2ボクセルに相当（当たり判定1ボクセル分）
- [ ] 右クリックで当たり判定ボクセルを配置できる
- [ ] 左クリックで当たり判定ボクセルを削除できる
- [ ] 配置・削除が即座に白いボクセル表示に反映される
- [ ] 4x4x4の範囲外には配置できない

### 簡易チェックモード
- [ ] 「簡易チェック」ボタンクリックで簡易チェックモードに切り替わる
- [ ] 上空から小さな球体（直径0.3ブロック相当）が大量に落下する
- [ ] 球体に重力が適用され落下する
- [ ] 当たり判定ボクセルとの衝突で球体が反射する
- [ ] 当たり判定が無い場所では球体がそのまま落下する
- [ ] 「編集に戻る」ボタンで編集モードに戻れる
- [ ] 編集モードに戻ると球体が消える

### 当たり判定データ
- [ ] ブロック選択時にvoxel_collisionデータが正しくデコードされて表示される
- [ ] 保存ボタンでvoxel_collisionデータが正しくエンコードされる
- [ ] 当たり判定が0個（全て通過可）の状態でも保存できる
- [ ] shape_type="normal"のブロック選択時は当たり判定編集不可の警告が表示される
