# 仕様書: 1-4 カスタムブロックエディタ

## 1. 概要

カスタムブロック（shape_type="custom"）を編集するWebベースのエディタを作る。
8x8x8のボクセルデータを3D表示し、マウス操作でボクセルの配置・削除・マテリアル変更ができる。
ページレイアウト、エディタ領域内のレイアウトは 1-3標準ブロックエディタを土台にする

ここで作る重要な部品は、
・カスタムブロックのメッシュ生成ライブラリ（ゲーム本体で利用）
・カスタムブロックのボクセル編集UI（管理ツールで利用）

src/test/ 及び src/game/ のディレクトリは公開用の Github リポジトリにプッシュする
公開用リポジトリ: https://github.com/masaru0ta/craftgame_public

## 2. 関連資料

- spec_1-1_block_data_sheet.md: データ構造
- spec_1-2_gas_api.md: API仕様
- spec_1-3_standard_block_editor.md: 標準ブロックエディタ（UIの参考）
- src/game/standard_block_editor.js
- src/test/spec_1-3_standard_block_editor.html
- src/test/spec_1-3_standard_block_editor_main.js
- src/test/spec_1-3_standard_block_editor_style.css

## 3. 機能詳細

### 3.1 画面構成

- 以下は 1-3 と同じ仕様
  - ２カラム。比率 4:6
  - 左カラムに block_id 選択のプルダウン、block_str_id（表示のみ）、name（表示のみ）、保存ボタンを表示
  - 右カラムに 3Dプレビュー兼編集。領域のアスペクト比は 1:1。

### 3.2 3Dプレビュー

- Three.jsを使用して 3Dプレビューを表示

#### 3.2.1 3Dプレビュー レイアウト

- 以下は 1-3 とほぼ同じ仕様
  - 3Dプレビュー枠の横:縦 = 3:4 のやや縦長の領域
  - 3Dプレビュー枠は右カラムの横幅いっぱいに表示
  - 3Dプレビュー枠内 上部 1/8 の領域に黒い帯を敷く。ここにツールボタンを置く枠とする
    - ツールボタン枠右端に、背景色切り換えボタン（四角い枠１つの下にBGと表記）。内部は現在の背景色で塗りつぶし。
    - 背景色切り換えボタンは下部のテクスチャ設定枠と同じ大きさ
  - 3Dプレビュー枠内 下部 1/8 の領域に黒い帯を敷く。ここにマテリアル設定を置く枠とする
  - 3Dプレビュー枠の中央にカスタムブロックを表示
  - 初期表示はFRONTが正面、垂直角度20度（少し上から見下ろす）、カメラ距離3（ブロックサイズの3倍）
  - 床面となる高さにブロックと同じ大きさの白い枠線と、その枠線の外側に FRONT, RIGHT, LEFT, BACK をテキスト表示
  - ウィンドウ幅が狭くなっても3Dプレビュー枠のサイズを自動調整するレスポンシブ設計

- 以下は 1-3 と異なる点
  - 床面となる高さにグリッド線（8x8）を表示
  - マテリアル設定は、３つのテクスチャ画像とラベルを表示
  - ラベルは 1, 2, 3
  - 各ボクセルに指定されたマテリアルのテクスチャを 8x8 全体に１枚のテクスチャを貼るUV座標で表示

#### 3.2.2 3Dプレビュー 操作

- 以下は 1-3 と同じ仕様
  - 背景色切り換えボタンクリックで背景色変化（黒 ＞ 青 ＞ 緑 ＞ 黒）
  - マウスドラッグで視点を回転させる。左右回転と上下の傾き変更が可能。
  - 上下の傾きは上側90度下側90度まで。マウスを右にドラッグすると、ブロックが右に回転する。
  - マウスのホイールスクロールで拡大縮小

- 以下は 1-3 と異なる点
  - ツールボタン枠に設置ボクセルサイズの切り換えボタン [4x][2x][1x] を設置
  - [1x] を選択すると 1ボクセルずつの設置・削除
  - [2x] を選択すると 2x2 ボクセルずつの設置・削除。ハイライトする面の大きさも 2x2 になる
  - [4x] を選択すると 4x4 ボクセルずつの設置・削除。ハイライトする面の大きさも 4x4 になる


### 3.2.3 3Dプレビュー ボクセル編集

- カーソル位置でレイキャストし対象のボクセルを常に選択
- 対象ボクセルのレイキャストした面を緑でハイライト、対象ボクセルの辺を赤で強調
- 対象ボクセルが無い場合は床面のグリッドをハイライト
- 右クリックでハイライトした面に隣接するようボクセルを配置（現在選択中のマテリアル）
- 左クリックで選択したボクセルを削除
- 選択された状態のマテリアルの画像をクリックするとテクスチャ選択画面（標準ブロックエディタと共用）

### 3.2.4 3Dプレビュー マテリアル選択

- 3Dプレビュー下部のオーバーレイでマテリアルを選択
- オーバーレイのマテリアルアイコンをクリックして切り替え
- 数字キー（1, 2, 3）でマテリアルを切り替え
- 現在選択中のマテリアルをハイライト表示

### 3.3 データ形式

#### voxel_look形式（8x8x8、2bit）
- 各ボクセルは2ビット（0-3）で表現
  - 0: 空気（透明）
  - 1: material_1
  - 2: material_2
  - 3: material_3
- データはY→Z→X順で格納
- Base64エンコードして保存

## 4. ファイル構成

```
src/
  test/
    spec_1-4_custom_block_editor.html       # メインHTML
    spec_1-4_custom_block_editor_style.css  # スタイル
    spec_1-4_custom_block_editor_main.js    # メインスクリプト
  game/
    custom_block_editor.js                  # カスタムブロック用エディターUI
    custom_block_mesh_builder.js            # カスタムブロック用メッシュ生成
    voxel_data.js                           # ボクセルデータのエンコード/デコード
```

## 5. 補足仕様

### 5.1 初期状態
- 新規ブロック作成時、または `voxel_look` が空のブロックを選択した場合、ボクセルは全て空(0)で開始

### 5.2 未設定マテリアルの表示
- material_1, 2, 3 のテクスチャが未設定の場合、テクスチャリストの最初から順に自動セット
- テクスチャリストが空の場合はグレー単色で表示

### 5.3 編集範囲の制限
- 8x8x8の範囲外にボクセルを配置しようとした場合は無視する（何も起こらない）

### 5.4 Undo/Redo機能
- 本仕様では実装しない

### 5.5 空の状態での保存
- ボクセルが0個（全て空）の状態でも保存を許可する

### 5.6 公開リポジトリへのプッシュ
- `craftgame_public` リポジトリへのプッシュは手動で行う

## 6. 実装詳細: UV座標マッピング

### 6.1 概要

8x8x8のボクセルグリッドに1枚のテクスチャを貼る場合、各ボクセルはテクスチャの1/64（8x8分割の1つ）を表示する。
Three.jsのBoxGeometryを使用する際、UV座標の設定には注意が必要。

### 6.2 Three.js BoxGeometryの面順序

BoxGeometryの面は以下の順序で定義されている（各面4頂点）:
- インデックス 0-3: +X (right)
- インデックス 4-7: -X (left)
- インデックス 8-11: +Y (top)
- インデックス 12-15: -Y (bottom)
- インデックス 16-19: +Z (front)
- インデックス 20-23: -Z (back)

### 6.3 各面のUV座標計算

各面でどの座標軸をU/Vに使用するか:

| 面            | U座標   | V座標   | flipU | flipV  |
|---------------|---------|---------|-------|--------|
| +X (right)    | 7 - z   | y       | true  | false  |
| -X (left)     | z       | y       | true  | false  |
| +Y (top)      | x       | 7 - z   | true  | false  |
| -Y (bottom)   | x       | z       | true  | false  |
| +Z (front)    | x       | y       | true  | false  |
| -Z (back)     | 7 - x   | y       | true  | false  |

### 6.4 flipU/flipVの役割

- **flipU**: U座標（水平方向）の反転。`true`の場合、uMax→uMinの順で貼る
- **flipV**: V座標（垂直方向）の反転。`true`の場合、vMin→vMaxの順で貼る

**重要**: 全ての面で`flipU = true`に設定する必要がある。これを`false`にすると、その面のテクスチャがボクセル単位で左右反転して表示される。

### 6.5 UV座標の設定コード例

```javascript
const setFaceUV = (startIdx, uCoord, vCoord, flipU = false, flipV = false) => {
  const uMin = uCoord / 8;
  const uMax = (uCoord + 1) / 8;
  const vMin = vCoord / 8;
  const vMax = (vCoord + 1) / 8;

  // flipUがtrueの場合、uMaxから始める（左右反転防止）
  let u0 = flipU ? uMax : uMin;
  let u1 = flipU ? uMin : uMax;
  let v0 = flipV ? vMin : vMax;
  let v1 = flipV ? vMax : vMin;

  // BoxGeometryの頂点順序に合わせて設定
  uvAttribute.setXY(startIdx + 0, u1, v0);
  uvAttribute.setXY(startIdx + 1, u0, v0);
  uvAttribute.setXY(startIdx + 2, u1, v1);
  uvAttribute.setXY(startIdx + 3, u0, v1);
};
```

### 6.6 よくある問題と解決策

| 問題                    | 原因                    | 解決策            |
|-------------------------|------------------------|-------------------|
| ボクセル単位で左右反転    | flipUがfalse           | flipUをtrueに設定  |
| ボクセル単位で上下反転    | flipVの設定が逆         | flipVの値を反転    |
| 面全体でテクスチャがずれる | uCoord/vCoordの計算ミス | 座標軸の選択を確認 |

## 7. テスト用CSSセレクタ定義

テストで数値検証が必要な要素のセレクタを定義する。実装はこれらのセレクタを使用すること。

| 要素 | セレクタ | 検証内容 |
|------|----------|----------|
| 右カラム | `.right-column` | 全幅の基準 |
| 3Dプレビュー枠 | `.preview-container` | アスペクト比 3:4 |
| ツールボタン枠 | `.toolbar` | 高さ 1/8 |
| 3Dプレビュー領域 | `.preview-3d` | 高さ 6/8 |
| マテリアル設定枠 | `.material-panel` | 高さ 1/8 |
| マテリアルスロット | `.material-slot` | 3つ存在 |
| 背景色表示 | `.bg-color-indicator` | 背景色の確認 |
| ブラシサイズボタン | `.brush-size-btn` | 3つ存在 |

## 8. テスト項目

### 画面表示
- [ ] Github にパブリッシュしたエディタ画面が正常に表示される
- [ ] 4:6 の比率で2カラム表示されている
- [ ] 左カラムにblock_id選択プルダウンが表示される
- [ ] 左カラムにblock_str_id、name、保存ボタンが表示される
- [ ] 右カラムに3Dプレビューが表示される

### 3Dプレビュー レイアウト（数値検証必須）
- [ ] `.preview-container`が`.right-column`の横幅いっぱいに表示される
  - 検証: `.preview-container`の幅 === `.right-column`のコンテンツ幅（誤差1px以内）
- [ ] `.preview-container`のアスペクト比が 横:縦 = 3:4 である
  - 検証: 幅 / 高さ === 0.75（誤差1%以内）
- [ ] `.toolbar`の高さが`.preview-container`の1/8である
  - 検証: `.toolbar`の高さ / `.preview-container`の高さ === 0.125（誤差1%以内）
- [ ] `.material-panel`の高さが`.preview-container`の1/8である
  - 検証: `.material-panel`の高さ / `.preview-container`の高さ === 0.125（誤差1%以内）
- [ ] `.preview-3d`の高さが`.preview-container`の6/8である
  - 検証: `.preview-3d`の高さ / `.preview-container`の高さ === 0.75（誤差1%以内）
- [ ] `.toolbar`の背景色が黒（#000000）である
- [ ] `.material-panel`の背景色が黒（#000000）である

### 3Dプレビュー 表示
- [ ] 8x8x8のボクセルグリッドが表示される
- [ ] 床面にグリッド線（8x8）が表示される
- [ ] グリッドの外側にFRONT, RIGHT, LEFT, BACKのテキストが表示されている
- [ ] 3Dプレビュー下部にマテリアルスロット（1, 2, 3）が表示される
- [ ] 各ボクセルにマテリアルのテクスチャが正しく表示される
- [ ] ツールボタン枠にブラシサイズ切り替えボタン [4x][2x][1x] が表示される
- [ ] ツールボタン枠右端にBGボタンが表示される（マテリアルスロットと同じスタイル）

### 3Dプレビュー 操作
- [ ] 背景をマウス左ドラッグで視点を回転できる
- [ ] 上下の傾きが上側90度、下側90度までに制限される
- [ ] マウスホイールで拡大縮小できる
- [ ] 背景色切り換えボタンクリックで背景色が変化する（黒 → 青 → 緑 → 黒）
- [ ] 背景色変更時にBGボタン内部（`.bg-color-indicator`）の色も更新される

### ボクセル編集
- [ ] カーソル位置のボクセルがハイライト表示される（選択面は緑、辺は赤）
- [ ] ボクセルが無い場合は床面のグリッドがハイライトされる
- [ ] 右クリックでハイライトした面に隣接するようボクセルを配置できる
- [ ] 左クリックで選択したボクセルを削除できる
- [ ] 配置したボクセルが即座に3Dプレビューに反映される
- [ ] 8x8x8の範囲外にはボクセルを配置できない
- [ ] [1x]選択時は1ボクセルずつ設置・削除
- [ ] [2x]選択時は2x2ボクセルずつ設置・削除、ハイライトも2x2
- [ ] [4x]選択時は4x4ボクセルずつ設置・削除、ハイライトも4x4

### マテリアル選択
- [ ] マテリアルスロット（`.material-slot`）をクリックでマテリアルを切り替えられる
- [ ] 数字キー（1, 2, 3）でマテリアルを切り替えられる
- [ ] 現在選択中のマテリアルがハイライト表示される
- [ ] 選択中のマテリアル画像をクリックするとテクスチャ選択画面が表示される

### データ読込
- [ ] 起動時にGAS APIからブロック一覧を取得できる
- [ ] 起動時にGAS APIからテクスチャ一覧を取得できる
- [ ] ブロック選択時にblock_str_id、nameが表示される
- [ ] ブロック選択時にvoxel_lookデータが正しくデコードされて表示される
- [ ] ブロック選択時にマテリアル設定が反映される

### データ保存
- [ ] 保存ボタンでvoxel_lookデータが正しくエンコードされる
- [ ] 保存ボタンでGAS APIにデータを送信できる
- [ ] 保存後にブロック一覧が更新される
- [ ] ボクセルが0個（全て空）の状態でも保存できる
