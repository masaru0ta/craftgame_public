# 仕様書: 1-4 カスタムブロックエディタ

## 1. 概要

カスタムブロック（shape_type="custom"）を編集するWebベースのエディタを作る。
8x8x8のボクセルデータを3D表示し、マウス操作でボクセルの配置・削除・マテリアル変更ができる。

ここで作る重要な部品は、
・カスタムブロックのメッシュ生成ライブラリ（ゲーム本体で利用）
・カスタムブロックのボクセル編集UI（管理ツールで利用）

src/test/ 及び src/game/ のディレクトリは公開用の Github リポジトリにプッシュする
公開用リポジトリ: https://github.com/masaru0ta/craftgame_public

## 2. 関連資料

- spec_1-1_block_data_sheet.md: データ構造
- spec_1-2_gas_api.md: API仕様
- spec_1-3_standard_block_editor.md: 標準ブロックエディタ（UIの参考）

## 3. 機能詳細

### 3.1 画面構成

- ２カラム。比率 4:6
- 左カラムに block_id 選択のプルダウン、block_str_id（表示のみ）、name（表示のみ）、保存ボタンを表示
- 右カラムに 3Dプレビュー兼編集。領域のアスペクト比は 1:1。

### 3.2 3Dプレビュー

- Three.jsを使用して 3Dプレビューを表示
- 8x8x8のボクセルグリッドを表示
- 床面となる高さにグリッド線（8x8）を表示
- グリッドの外側に FRONT, RIGHT, LEFT, BACK をテキスト表示
- 3Dプレビュー枠内の下部に、３つのマテリアルのテクスチャ画像とラベルを表示
- ラベルは 1, 2, 3
- 各ボクセルに指定されたマテリアルのテクスチャを 8x8 全体に１枚のテクスチャを貼るUV座標で表示
- 背景をマウス左ドラッグで視点を回転させる。左右回転と上下の傾き変更が可能
- 回転方向は、右にドラッグするとブロックが右に向く回転
- 上下の傾きは上側90度下側90度まで。マウスを右にドラッグすると、右に回転する。
- マウスのホイールスクロールで拡大縮小

### 3.3 ボクセル編集

- カーソル位置でレイキャストし対象のボクセルを常に選択
- 対象ボクセルのレイキャストした面を緑でハイライト、それ以外の面を赤でハイライト
- 対象ボクセルが無い場合は床面のグリッドをハイライト
- 右クリックでハイライトした面に隣接するようボクセルを配置（現在選択中のマテリアル）
- 左クリックで選択したボクセルを削除

### 3.4 マテリアル選択

- 左カラムに3つのマテリアルスロット（material_1, material_2, material_3）を表示
- 各スロットをクリックするとテクスチャ選択画面を表示
- 数字キー（1, 2, 3）でマテリアルを切り替え
- 現在選択中のマテリアルをハイライト表示

### 3.5 データ形式

#### voxel_look形式（8x8x8、2bit）
- 各ボクセルは2ビット（0-3）で表現
  - 0: 空気（透明）
  - 1: material_1
  - 2: material_2
  - 3: material_3
- データはY→Z→X順で格納
- Base64エンコードして保存

### 3.6 レスポンシブ対応

- ウィンドウ幅が狭くなっても3Dプレビュー枠のサイズを自動調整する

## 4. ファイル構成

```
src/
  test/
    spec_1-4_custom_block_editor.html       # メインHTML
    spec_1-4_custom_block_editor_style.css  # スタイル
    spec_1-4_custom_block_editor_main.js    # メインスクリプト
  game/
    custom_block_editor.js                  # カスタムブロック用エディターUI
    custom_block_mesh_builder.js            # カスタムブロック用メッシュ生成
    voxel_data.js                           # ボクセルデータのエンコード/デコード
```

## 6. 実装詳細: UV座標マッピング

### 6.1 概要

8x8x8のボクセルグリッドに1枚のテクスチャを貼る場合、各ボクセルはテクスチャの1/64（8x8分割の1つ）を表示する。
Three.jsのBoxGeometryを使用する際、UV座標の設定には注意が必要。

### 6.2 Three.js BoxGeometryの面順序

BoxGeometryの面は以下の順序で定義されている（各面4頂点）:
- インデックス 0-3: +X (right)
- インデックス 4-7: -X (left)
- インデックス 8-11: +Y (top)
- インデックス 12-15: -Y (bottom)
- インデックス 16-19: +Z (front)
- インデックス 20-23: -Z (back)

### 6.3 各面のUV座標計算

各面でどの座標軸をU/Vに使用するか:

| 面 | U座標 | V座標 | flipU | flipV |
|---|---|---|---|---|
| +X (right) | 7 - z | y | true | false |
| -X (left) | z | y | true | false |
| +Y (top) | x | 7 - z | true | false |
| -Y (bottom) | x | z | true | false |
| +Z (front) | x | y | true | false |
| -Z (back) | 7 - x | y | true | false |

### 6.4 flipU/flipVの役割

- **flipU**: U座標（水平方向）の反転。`true`の場合、uMax→uMinの順で貼る
- **flipV**: V座標（垂直方向）の反転。`true`の場合、vMin→vMaxの順で貼る

**重要**: 全ての面で`flipU = true`に設定する必要がある。これを`false`にすると、その面のテクスチャがボクセル単位で左右反転して表示される。

### 6.5 UV座標の設定コード例

```javascript
const setFaceUV = (startIdx, uCoord, vCoord, flipU = false, flipV = false) => {
  const uMin = uCoord / 8;
  const uMax = (uCoord + 1) / 8;
  const vMin = vCoord / 8;
  const vMax = (vCoord + 1) / 8;

  // flipUがtrueの場合、uMaxから始める（左右反転防止）
  let u0 = flipU ? uMax : uMin;
  let u1 = flipU ? uMin : uMax;
  let v0 = flipV ? vMin : vMax;
  let v1 = flipV ? vMax : vMin;

  // BoxGeometryの頂点順序に合わせて設定
  uvAttribute.setXY(startIdx + 0, u1, v0);
  uvAttribute.setXY(startIdx + 1, u0, v0);
  uvAttribute.setXY(startIdx + 2, u1, v1);
  uvAttribute.setXY(startIdx + 3, u0, v1);
};
```

### 6.6 よくある問題と解決策

| 問題 | 原因 | 解決策 |
|---|---|---|
| ボクセル単位で左右反転 | flipUがfalse | flipUをtrueに設定 |
| ボクセル単位で上下反転 | flipVの設定が逆 | flipVの値を反転 |
| 面全体でテクスチャがずれる | uCoord/vCoordの計算ミス | 座標軸の選択を確認 |

## 7. テスト項目

### 画面表示
- [ ] Github にパブリッシュしたエディタ画面が正常に表示される
- [ ] 4:6 の比率で2カラム表示されている
- [ ] 左カラムにblock_id選択プルダウンが表示される
- [ ] 左カラムにblock_str_id、name、保存ボタンが表示される
- [ ] 左カラムに3つのマテリアルスロットが表示される
- [ ] 左カラムに編集モード切替が表示される
- [ ] 右カラムに3Dプレビューが表示される

### 3Dプレビュー
- [ ] 8x8x8のボクセルグリッドが表示される
- [ ] 床面にグリッド線（8x8）が表示される
- [ ] グリッドの外側にFRONT, RIGHT, LEFT, BACKのテキストが表示されている
- [ ] 背景をマウス左ドラッグで視点を回転できる
- [ ] 上下の傾きが上側90度、下側90度までに制限される
- [ ] マウスホイールで拡大縮小できる
- [ ] 各ボクセルにマテリアルのテクスチャが正しく表示される

### ボクセル編集
- [ ] カーソル位置のボクセルがハイライト表示される（選択面は緑、それ以外は赤）
- [ ] 右クリックでハイライトした面に隣接するようボクセルを配置できる
- [ ] 左クリックで選択したボクセルを削除できる
- [ ] 配置したボクセルが即座に3Dプレビューに反映される

### マテリアル選択
- [ ] マテリアルスロットクリックでテクスチャ選択画面が表示される
- [ ] テクスチャを選択するとマテリアルスロットに反映される
- [ ] 数字キー（1, 2, 3）でマテリアルを切り替えられる
- [ ] 現在選択中のマテリアルがハイライト表示される

### データ読込
- [ ] 起動時にGAS APIからブロック一覧を取得できる
- [ ] 起動時にGAS APIからテクスチャ一覧を取得できる
- [ ] ブロック選択時にblock_str_id、nameが表示される
- [ ] ブロック選択時にvoxel_lookデータが正しくデコードされて表示される
- [ ] ブロック選択時にマテリアル設定が反映される

### データ保存
- [ ] 保存ボタンでvoxel_lookデータが正しくエンコードされる
- [ ] 保存ボタンでGAS APIにデータを送信できる
- [ ] 保存後にブロック一覧が更新される
