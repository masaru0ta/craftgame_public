# 仕様書: 2-2 チャンク管理テスト

## 概要

視点を中心としたNxNチャンクの動的生成・ローカルストレージ保存・読込が正しく動作するかテストするページ。
視点を自動移動させながら、チャンク管理システムのパフォーマンスと正確性を検証する。

## 関連資料

- spec_list.md: 機能一覧
- spec_2-1_generate_1chunk.md: 1チャンク生成・表示テスト

## 技術構成

| 項目 | 選定 |
|------|------|
| 3Dライブラリ | Three.js（CDN） |
| カメラ操作 | OrbitControls（観察用） |
| ストレージ | IndexedDB（idbライブラリ使用） |
| テスト方法 | テストページ（HTML） |

## ファイル構成

```
src/
├── game/                           # ゲーム本体で使用するライブラリ
│   ├── ChunkData.js                # 既存: チャンクデータ管理
│   ├── ChunkMeshBuilder.js         # 既存: メッシュ生成
│   ├── TextureLoader.js            # 既存: テクスチャ取得
│   ├── WorldGenerator.js           # 既存: 地形生成
│   ├── ChunkManager.js             # 新規: 複数チャンクの管理
│   └── ChunkStorage.js             # 新規: ローカルストレージ連携
├── test/
│   ├── 2-2_chunk_manager_test.html # 新規: テストページ
│   └── 2-2_main.js                 # 新規: メイン処理
```

---

## 要件

### **REQ-2-2-1: チャンク管理クラス（ChunkManager）**

- 視点座標を中心としたNxN範囲のチャンクを管理する
- Nの値はUIから変更可能（デフォルト: 3）
- 視点移動に応じて以下を行う:
  - NxN範囲内に入った未生成チャンク → 生成してメッシュ作成
  - NxN範囲外になったチャンク → ストレージに保存してメモリから解放
- チャンク生成時、ストレージに保存済みデータがあれば読み込んで復元する
- チャンク生成時、保存済みデータがなければ WorldGenerator で新規生成する

#### 管理するチャンクの状態

| 状態 | 説明 |
|------|------|
| unloaded | 未読み込み（メモリ上にない） |
| loading | 読み込み中 |
| active | 表示中（メッシュがシーンにある） |
| unloading | 保存・解放中 |

#### チャンク生成の制御

- 生成処理は **非同期** で行い、メインスレッドをブロックしない
- 生成待ちのチャンクは **キュー** で管理する
- キューの優先度: 視点に近いチャンクを優先
- **1フレームで生成するチャンク数の制限**:
  - `chunksPerFrame`で設定可能（デフォルト: 2）
  - `ChunkManager.setChunksPerFrame(n)`で変更可能
  - 残りのキューは次フレーム以降で処理

#### チャンク座標の視覚表示

各チャンクの地表にチャンク座標（X, Z）をブロックで描画し、どのチャンクか視覚的に識別できるようにする。

**数字の表現:**
- 7セグメント風パターン（1文字 = 3×5ブロック）
- 0〜9 の数字パターンを定義

**負の数の表現:**
- マイナス記号は描画しない
- ブロック種類で正負を区別:
  - 正の数: stone ブロック
  - 負の数: dirt ブロック

**配置:**
- チャンク中央付近、地表（y=64）に水平に寝かせて描画
- X座標を北側（Z+方向）、Z座標を南側（Z-方向）に配置
- 数字は地表面（X-Z平面）に沿って配置（立体的に立てない）
- 数字の上部が北側（Z+方向）を向くように配置（南側から見て正しく読める）
- 数字間のスペース: 1ブロック

**例: チャンク (12, -5) の場合**
```
  ■     ■■■    ← X座標 "12" (stone = 正)
  ■       ■
  ■     ■■■
  ■     ■
  ■     ■■■

  (1ブロック空け)

  ■■■   ■■■    ← Z座標 "5" (dirt = 負)
  ■     ■
  ■■■   ■■■
    ■     ■
  ■■■   ■■■
```

---

### **REQ-2-2-2: チャンクストレージクラス（ChunkStorage）**

- IndexedDB にチャンクデータを保存・読込する
- idb ライブラリを使用（CDN: `https://cdn.jsdelivr.net/npm/idb@8/build/umd.js`）
- データベース名: `craftgame5`
- オブジェクトストア名: `chunks`
- キー形式: `{worldName}_chunk_{chunkX}_{chunkZ}`
- デフォルトのワールド名: `world1`
- 保存データ形式: パレット + 可変ビットバイナリ方式（後述）
- 以下のメソッドを提供（すべて非同期）:
  - `async save(worldName, chunkX, chunkZ, chunkData)`: チャンクを保存
  - `async load(worldName, chunkX, chunkZ)`: チャンクを読込（なければnull）
  - `async exists(worldName, chunkX, chunkZ)`: 保存済みか確認
  - `async clear(worldName)`: 指定ワールドの全チャンクを削除
  - `async getStoredChunkCount(worldName)`: 保存済みチャンク数を取得

#### パレット + 可変ビットバイナリ方式

チャンク内で使用されているブロック種類を「パレット」として定義し、各ブロックをパレットのインデックスで表現する。インデックスはパレットサイズに応じた可変ビット数でバイナリ化する。

**ビット数の決定:**

| パレットサイズ | ビット数 | 表現可能な種類 |
|---------------|---------|---------------|
| 1〜2種類 | 1bit | 2 |
| 3〜4種類 | 2bit | 4 |
| 5〜16種類 | 4bit | 16 |
| 17〜256種類 | 8bit | 256 |

**保存データ構造:**

```javascript
{
  palette: ["air", "stone", "dirt", "grass"],  // 使用ブロック一覧
  bitsPerBlock: 2,                              // ブロックあたりのビット数
  data: Uint8Array([...])                       // バイナリデータ
}
```

**ブロックの格納順序:**
- Y → Z → X の順（Y が最も内側のループ）
- インデックス = x * SIZE_Y * SIZE_Z + z * SIZE_Y + y
- これにより縦方向（Y軸）に連続するブロックが連続して格納される

**サイズ試算（1チャンク = 16 × 128 × 16 = 32,768ブロック）:**

| パレットサイズ | ビット数 | データサイズ |
|---------------|---------|-------------|
| 4種類以下 | 2bit | 約8KB |
| 16種類以下 | 4bit | 約16KB |
| 256種類以下 | 8bit | 約33KB |

---

### **REQ-2-2-3: 連続移動テスト**

- 以下のパラメータを指定して連続移動テストを実行する:
  - **移動距離**: Xチャンク（UIで指定）
  - **移動方向**: 北 / 南 / 北西 / 南東（UIで選択）
- 移動速度は3段階から選択可能（低速 / 中速 / 高速）
- テスト完了時に以下の結果を表示:
  - 平均FPS
  - 最低FPS
  - 生成したチャンク総数
  - うち新規生成数
  - うち保存済み読込数
- 折り返し機能は持たない（逆方向テストは再度実行する）

#### 移動方向の定義

| 方向 | 説明 | チャンク座標の変化 |
|------|------|-------------------|
| 北 | Z+方向 | chunkZ が増加 |
| 南 | Z-方向 | chunkZ が減少 |
| 北西 | X-かつZ+方向 | chunkX減少、chunkZ増加 |
| 南東 | X+かつZ-方向 | chunkX増加、chunkZ減少 |

#### 移動速度

| 段階 | 名前 | 速度（ブロック/秒） |
|------|------|---------------------|
| 1 | 低速 | 8 |
| 2 | 中速 | 16 |
| 3 | 高速 | 32 |

---

### **REQ-2-2-4: 手動操作**

- キーボードで視点を手動移動できる
- 操作方法:
  - W: 北へ移動（Z+）
  - S: 南へ移動（Z-）
  - A: 西へ移動（X-）
  - D: 東へ移動（X+）
- 手動操作中もチャンクの生成・保存・読込が動作する
- 連続移動テスト中は手動操作を無効化する
- **iframeで埋め込まれた場合**: クリックでフォーカスを取得してキー操作を有効化

---

### **REQ-2-2-5: デバッグUI**

- 画面左上にデバッグパネルを表示する
- 表示・操作項目:
  - **NxN範囲**: 選択（9, 15, 21, 31）
  - **生成数/F**: 1フレームあたりの生成チャンク数（デフォルト: 2、セレクタ: `#input-chunks-per-frame`）
  - **ワイヤーフレーム**: ON/OFF切り替えボタン
  - **グリーディーメッシング**: ON/OFF切り替えボタン（デフォルト: ON）
  - **カリング**: ON/OFF切り替えボタン（デフォルト: ON）
  - **チャンク範囲表示**: NxN範囲の外周を赤い四角線で表示
  - **ドローコール数**: リアルタイム表示
  - **ポリゴン総数**: リアルタイム表示
  - **現在の視点座標**: リアルタイム表示（チャンク座標も併記）
  - **読込済みチャンク数**: 現在メモリ上にあるチャンク数
  - **ストレージ保存済み数**: ローカルストレージに保存されているチャンク数
  - **FPSグラフ**: 直近のFPS履歴をグラフで可視化（セレクタ: `#fps-graph`、履歴120秒分、1秒ごとに更新）
  - **新規生成時間**: 1チャンクの新規生成にかかる平均時間（ms）
  - **読込生成時間**: 1チャンクのストレージ読込＋メッシュ生成にかかる平均時間（ms）
  - **保存解放時間**: 1チャンクの保存＋メッシュ削除にかかる平均時間（ms）

#### 連続移動テスト操作パネル

- **移動距離入力**: 数値入力（デフォルト: 10）
- **移動方向選択**: 北 / 南 / 北西 / 南東
- **移動速度選択**: 低速 / 中速 / 高速
- **テスト開始ボタン**: クリックでテスト開始
- **テスト結果表示エリア**: テスト完了後に結果を表示

#### その他の操作

- **ストレージクリアボタン**: 現在のワールドの保存データを全削除
- **リセットボタン**: 視点を原点に戻し、全チャンクを再読込

#### 手動移動と速度設定

- 手動移動（WASD）の速度は、速度プルダウン（低速/中速/高速）の設定に従う
- 速度プルダウンを変更すると、手動移動速度も即座に反映される

---

### **REQ-2-2-5-1: テクスチャアトラス**

- TextureLoaderでテクスチャアトラスを自動生成する
- 全ブロックのテクスチャを1枚の画像にまとめる
- アトラスサイズは自動計算（テクスチャ数に応じて拡張）
- 1チャンク = 1メッシュ = 1マテリアル = 1ドローコール
- `TextureLoader.getAtlasMaterial()` でアトラスマテリアルを取得
- `TextureLoader.getAtlasUV(blockStrId, faceName)` でUV座標を取得

#### グリーディーメッシングとテクスチャタイリング

- グリーディーメッシングで複数ブロックをマージした場合、テクスチャを正しくタイリングする
- アトラステクスチャでは通常のリピートが使えないため、マージされた面を元のタイル単位で分割して描画する
- これによりドローコールは1のまま、テクスチャの見た目が正しくなる

---

### **REQ-2-2-6: Three.js シーン構成**

- 2-1と同様の構成を踏襲する
- 左手座標系（worldContainer で Z軸反転）
- 背景色は空色（#87CEEB）
- 照明は DirectionalLight + AmbientLight
- **カメラ追従**: 視点移動に応じてカメラ位置も追従する（視点を見下ろす角度を維持）
- OrbitControls で観察可能（ユーザーがドラッグで角度を変えられる）

---

### **REQ-2-2-7: block_manager.html への統合**

- `src/tool/block_manager.html` に「チャンク管理テスト」タブを追加する
- タブをクリックするとチャンク管理テストページが表示される
- テストページは `iframe` で `../test/2-2_chunk_manager_test.html` を埋め込む
- iframe は画面いっぱいに表示する

---

## UIセレクタ（テスト用）

Playwrightテストで使用するセレクタを定義する。

### テストページ内

| 要素 | セレクタ | 説明 |
|------|---------|------|
| キャンバス | `#game-canvas` | Three.jsの描画キャンバス |
| デバッグパネル | `#debug-panel` | デバッグ情報表示パネル |
| NxN範囲選択 | `#select-chunk-range` | チャンク範囲の選択 |
| 生成数/F入力 | `#input-chunks-per-frame` | 1フレームあたりの生成チャンク数 |
| ワイヤーフレームボタン | `#btn-wireframe` | ワイヤーフレーム切り替え |
| グリーディーボタン | `#btn-greedy` | グリーディーメッシング切り替え（デフォルト: ON） |
| カリングボタン | `#btn-culling` | カリング切り替え（デフォルト: ON） |
| ドローコール表示 | `#debug-drawcalls` | ドローコール数 |
| ポリゴン数表示 | `#debug-triangles` | ポリゴン総数 |
| 視点座標表示 | `#debug-position` | 現在の視点座標 |
| 読込済みチャンク数 | `#debug-loaded-chunks` | メモリ上のチャンク数 |
| ストレージ保存数 | `#debug-stored-chunks` | ストレージのチャンク数 |
| FPSグラフ | `#fps-graph` | FPS履歴のグラフ表示 |
| 新規生成時間 | `#debug-avg-new-time` | 新規生成の平均時間（ms） |
| 読込生成時間 | `#debug-avg-load-time` | 読込生成の平均時間（ms） |
| 保存解放時間 | `#debug-avg-unload-time` | 保存解放の平均時間（ms） |
| 移動距離入力 | `#input-move-distance` | 連続移動の距離 |
| 移動方向選択 | `#select-move-direction` | 連続移動の方向 |
| 移動速度選択 | `#select-move-speed` | 連続移動の速度 |
| テスト開始ボタン | `#btn-start-test` | 連続移動テスト開始 |
| テスト結果表示 | `#test-results` | テスト結果の表示エリア |
| 結果: 平均FPS | `#result-avg-fps` | 平均FPS |
| 結果: 最低FPS | `#result-min-fps` | 最低FPS |
| 結果: 生成チャンク数 | `#result-total-chunks` | 生成したチャンク総数 |
| 結果: 新規生成数 | `#result-new-chunks` | 新規生成チャンク数 |
| 結果: 読込数 | `#result-loaded-chunks` | 保存済み読込チャンク数 |
| テスト状態 | `#test-status` | テスト実行中/完了の状態 |
| ストレージクリアボタン | `#btn-clear-storage` | ストレージ削除 |
| リセットボタン | `#btn-reset` | リセット |

### block_manager.html内

| 要素 | セレクタ | 説明 |
|------|---------|------|
| チャンク管理テストタブ | `.tab[data-tab="chunkManagerTest"]` | タブボタン |
| チャンク管理テストコンテンツ | `#chunkManagerTest` | タブコンテンツ |
| iframe | `#chunkManagerTestFrame` | テストページを埋め込むiframe |

---

## テスト方針

### 機能テスト

1. **チャンク生成テスト**
   - 視点移動でNxN範囲のチャンクが正しく生成されるか
   - 範囲外のチャンクがストレージに保存されるか

2. **チャンク読込テスト**
   - 保存済みチャンクが正しく復元されるか
   - 新規生成と保存済み読込が正しくカウントされるか

3. **連続移動テスト**
   - 指定距離・方向で移動が完了するか
   - テスト結果が正しく表示されるか

4. **手動操作テスト**
   - WASDキーで視点が移動するか
   - 移動に応じてチャンクが生成・解放されるか

5. **UI操作テスト**
   - 各ボタン・入力が正しく動作するか
   - ストレージクリアが動作するか

---

## 補足

- Three.js CDN: `https://cdn.jsdelivr.net/npm/three@0.128.0/`
- OrbitControls CDN: `https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js`
