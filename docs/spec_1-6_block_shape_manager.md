# 仕様書: 1-6 ブロック形状管理ツール

## 1. 概要

ブロック形状一覧を表示し、標準ブロック・カスタムブロックの編集ができる統合管理ツールを作る。
1-3（標準ブロックエディタ）、1-4/1-5（カスタムブロックエディタ）の機能を1つの画面から利用できるようにする。

**重要**: このツールでは BlockEditorUI クラスを新規作成し、UI生成・イベントハンドリング・エディタ切替を一括管理する。
これにより、1-3, 1-4, 1-5 で作成したコアクラスを再利用し、コードの重複を避ける。

主な機能:
- ブロック形状一覧のグリッド表示（サムネイル付き）
- ブロック形状ごとの基本情報の編集
- ブロック形状（テクスチャ・カスタムブロック・当たり判定）の編集
- テクスチャの編集

src/test/ 及び src/game/ のディレクトリは公開用の Github リポジトリにプッシュする
公開用リポジトリ: https://github.com/masaru0ta/craftgame_public

## 2. 関連資料

- spec_1-1_block_data_sheet.md: データ構造
- spec_1-2_gas_api.md: API仕様
- spec_1-3_standard_block_editor.md: StandardBlockEditor クラス
- spec_1-4_custom_block_editor.md: CustomBlockEditor クラス
- spec_1-5_collision_editor.md: CollisionChecker クラス

## 3. アーキテクチャ

### 3.1 クラス構成

```
block_manager_main.js
    └── BlockEditorUI (新規作成)
        ├── StandardBlockEditor (1-3)
        │   └── StandardBlockMeshBuilder
        └── CustomBlockEditor (1-4)
            ├── CustomBlockMeshBuilder
            └── CollisionChecker (1-5)
```

### 3.2 BlockEditorUI クラス

BlockEditorUI は以下の責務を持つ:

| 責務 | 説明 |
|------|------|
| UI生成 | 3Dプレビュー枠、ツールバー、コントロールパネルを自動生成 |
| イベントハンドリング | 背景色切替、ブラシサイズ、マテリアル選択などのイベント処理 |
| エディタ切替 | ブロックタイプに応じてStandardBlockEditorまたはCustomBlockEditorを使用 |
| モード管理 | カスタムブロックの見た目/当たり判定モード切替 |
| 衝突テスト | CollisionCheckerの開始/停止制御 |

#### コンストラクタ

```javascript
constructor(options) {
  // options.container: UIをマウントするDOM要素
  // options.THREE: Three.jsライブラリ
  // options.onBlockChange: ブロックデータ変更時コールバック (optional)
  // options.onTextureSelect: テクスチャ選択要求時コールバック (optional)
}
```

#### 公開メソッド

| メソッド | 説明 |
|----------|------|
| `init()` | UIを生成し、エディタを初期化 |
| `loadBlock(blockData, textures)` | ブロックデータをロードして表示 |
| `getBlockData()` | 現在のブロックデータを取得 |
| `setBackgroundColor(color)` | 背景色を設定 |
| `resize()` | リサイズ処理 |
| `dispose()` | リソース解放 |

### 3.3 責務分離

| クラス | 責務 |
|--------|------|
| BlockEditorUI | UI生成、イベントハンドリング、エディタ切替 |
| StandardBlockEditor | 標準ブロックの3D表示、テクスチャ管理 |
| CustomBlockEditor | カスタムブロックの3D表示、ボクセル編集 |
| CollisionChecker | 衝突テストのボール物理演算 |

## 4. 機能詳細

### 4.1 画面構成

#### 4.1.1 全体構成

- 画面上部にタブバー（「ブロック一覧」「テクスチャ一覧」）
- タブ切り替えでメインコンテンツが切り替わる

#### 4.1.2 ブロック状態一覧画面

3カラム構成（比率 3:2:5）

**左カラム: ブロック一覧グリッド**
- ブロックをタイル形式でグリッド表示
- 各タイルにサムネイル画像（48x48px）と表示名
- 選択中のタイルはハイライト表示
- 最後に「+ 新規追加」タイル（破線枠）

**中央カラム: 基本情報**
- 見出し「基本情報」
- フォーム項目:
  - ブロックID（block_str_id）: テキスト入力、必須
  - 表示名（name）: テキスト入力、必須
  - ブロックタイプ（shape_type）: プルダウン（通常ブロック / カスタムブロック）
  - ドロップアイテム（drop_item）: テキスト入力
  - 発光レベル（light_level）: 数値入力（0-15）
  - オプション:
    - 透過ブロック（is_transparent）: チェックボックス
- ボタン行: 「削除」ボタン（赤）、「保存」ボタン（青）

**右カラム: 3Dプレビュー枠（BlockEditorUI）**
- アスペクト比 横:縦 = 3:4 の黒い枠
- カラム横幅いっぱいに表示
- BlockEditorUI がUI生成とエディタ切替を自動管理
- 通常ブロック時: StandardBlockEditor を使用
- カスタムブロック時: CustomBlockEditor を使用

### 4.2 BlockEditorUI が生成するUI

BlockEditorUI は以下のUI要素を自動生成する:

#### 4.2.1 3Dプレビュー枠レイアウト

```
┌─────────────────────────────────┐
│ ツールバー (1/8)                 │
│ [モード切替][ブラシ]      [BG]  │
├─────────────────────────────────┤
│                                 │
│     3Dプレビュー領域 (6/8)      │
│                                 │
├─────────────────────────────────┤
│ コントロールパネル (1/8)        │
│ [テクスチャ/マテリアル][操作]   │
└─────────────────────────────────┘
```

#### 4.2.2 ツールバー要素

| 要素 | 表示条件 | 説明 |
|------|----------|------|
| モード切替ボタン | カスタムブロック時 | 見た目/当たり判定切替、ミニプレビュー表示 |
| ブラシサイズボタン | カスタムブロック時 | [4x][2x][1x]、当たり判定モード時は[2x]固定 |
| 背景色ボタン | 常時 | 背景色切替（黒→青→緑→黒） |

#### 4.2.3 コントロールパネル要素

| モード | 表示内容 |
|--------|----------|
| 標準ブロック | テクスチャスロット7つ（default, top, bottom, front, back, left, right） |
| カスタム・見た目 | マテリアルスロット3つ + 衝突テストボタン |
| カスタム・当たり判定 | 自動作成ボタン + 衝突テストボタン |

### 4.3 イベントハンドリング

BlockEditorUI が処理するイベント:

| イベント | 処理 |
|----------|------|
| 背景色ボタンクリック | 背景色を切替 |
| ブラシサイズボタンクリック | ブラシサイズを変更 |
| モード切替ボタンクリック | 見た目/当たり判定モードを切替 |
| テクスチャスロットクリック | onTextureSelectコールバックを呼び出し |
| マテリアルスロットクリック | マテリアル選択を変更 |
| マテリアルスロットダブルクリック | onTextureSelectコールバックを呼び出し |
| 自動作成ボタンクリック | CustomBlockEditor.autoCreateCollision()を呼び出し |
| 衝突テストボタンクリック | CollisionCheckerを開始/停止 |

### 4.4 テクスチャ一覧画面

2カラム構成（比率 7:3）

**左カラム: テクスチャ一覧**
- 見出し「テクスチャ一覧」
- テクスチャをタイル形式でグリッド表示
- 各タイルにサムネイル画像、テクスチャID、ファイル名
- 選択中のタイルはハイライト表示

**右カラム: テクスチャ詳細**
- 見出し「テクスチャ詳細」
- プレビュー画像（100x100px）
- フォーム項目:
  - テクスチャID（texture_id）: 数値表示、読み取り専用
  - ファイル名（file_name）: テキスト表示、読み取り専用
  - 代表色（color_hex）: カラーピッカー + テキスト入力
- ボタン行: 「削除」ボタン（赤）、「保存」ボタン（青）

### 4.5 新規ブロック作成

#### 4.5.1 新規作成モーダル

「新規作成」ボタンクリックで表示されるモーダル:
- block_str_id 入力欄（必須、英数字とアンダースコアのみ）
- name 入力欄（必須）
- shape_type 選択（「標準」/「カスタム」ラジオボタン）
- 「作成」ボタン
- 「キャンセル」ボタン

#### 4.5.2 新規作成処理

1. 入力バリデーション
   - block_str_id が空でないこと
   - block_str_id が既存のブロックと重複しないこと
   - block_str_id が英数字とアンダースコアのみで構成されること
   - name が空でないこと
2. GAS API で新規ブロックを作成
3. 作成成功後、一覧が更新され新規ブロックが選択状態になる

### 4.6 ブロック編集

#### 4.6.1 ブロック選択

ページ読み込み時、ブロック一覧の先頭（block_id が最小）を自動選択する。

左カラムのタイルをクリックすると:
- 選択状態になりハイライト表示される
- 中央カラムに選択したブロックの基本情報が表示される
- 右カラムのBlockEditorUIに選択したブロックがロードされる

未保存の変更がある状態で別のブロックを選択した場合:
- 「変更が保存されていません。破棄しますか？」確認ダイアログを表示
- 「OK」で変更を破棄して選択を切り替え
- 「キャンセル」で選択を維持

#### 4.6.2 ブロックタイプ変更

ブロックタイプ（通常ブロック ↔ カスタムブロック）を変更した場合:
- 「ブロックタイプを変更すると関連データがクリアされます。よろしいですか？」確認ダイアログを表示
- 「OK」で shape_type を変更し、関連データをクリア
- 「キャンセル」で変更を取り消し

## 5. ファイル構成

```
src/
  tool/
    block_manager.html            # 一覧画面HTML
    block_manager_style.css       # 共通スタイル
    block_manager_main.js         # 一覧画面スクリプト
  game/
    block_editor_ui.js            # BlockEditorUI クラス（新規作成）
    standard_block_editor.js      # 標準ブロックエディタ（1-3）
    custom_block_editor.js        # カスタムブロックエディタ（1-4）
    custom_collision_checker.js   # 衝突テストチェッカー（1-5）
    standard_block_mesh_builder.js
    custom_block_mesh_builder.js
    voxel_data.js
    custom_collision.js
    gas_api.js
    block_thumbnail.js            # サムネイル生成ライブラリ
```

## 6. 補足仕様

### 6.1 サムネイルのキャッシュ

- ブロック一覧取得時にサムネイルをキャッシュ
- ブロック更新時にキャッシュを無効化
- メモリ内キャッシュのみ（永続化なし）

### 6.2 一覧のソート

- デフォルトは block_id 昇順

### 6.3 レスポンシブ対応

グリッド列数の変更:
- 幅 1200px 以上: 4列
- 幅 900px 以上: 3列
- 幅 600px 以上: 2列
- 幅 600px 未満: 1列

## 7. テスト用CSSセレクタ定義

| 要素 | セレクタ | 検証内容 |
|------|----------|----------|
| タブバー | `.tabs` | タブ切り替え |
| タブ | `.tab` | ブロック一覧/テクスチャ一覧 |
| アクティブタブ | `.tab.active` | 選択中のタブ |
| メインコンテンツ | `.main` | タブに対応するコンテンツ |
| アクティブコンテンツ | `.main.active` | 表示中のコンテンツ |
| 左カラム | `.col-left` | ブロック一覧グリッド |
| 中央カラム | `.col-mid` | 基本情報フォーム |
| 右カラム | `.col-right` | 3Dプレビュー枠 |
| グリッド | `.grid` | タイルのグリッド表示 |
| タイル | `.tile` | 各ブロック/テクスチャのタイル |
| 選択中タイル | `.tile.selected` | 選択状態 |
| 3Dプレビュー枠 | `.preview-container` | BlockEditorUIのコンテナ |
| ツールバー | `.preview-toolbar` | ツールボタン枠 |
| コントロールパネル | `.control-panel` | テクスチャ/マテリアル設定枠 |
| モード切替ボタン | `.mode-toggle-btn` | 見た目/当たり判定切り替え |
| ブラシサイズボタン | `.brush-size-btn` | ブラシサイズ切り替え |
| 背景色ボタン | `.bg-btn` | 背景色切り替え |
| マテリアルスロット | `.material-item` | マテリアル選択 |
| テクスチャスロット | `.material-item` | テクスチャ選択 |
| 自動作成ボタン | `.auto-create-btn` | 当たり判定自動生成 |
| 衝突テストボタン | `.check-btn` | 衝突テスト開始/停止 |

## 8. テスト項目

### 全体構成

- [x] Github にパブリッシュした画面が正常に表示される
- [x] 画面上部にタブバー（「ブロック一覧」「テクスチャ一覧」）が表示される
- [x] タブクリックでメインコンテンツが切り替わる
- [x] ページ読み込み後、ブロック一覧に `.tile` が1つ以上表示される

### ブロック状態一覧画面 - レイアウト

- [x] `.col-left`、`.col-mid`、`.col-right` の3カラムが表示される
- [x] 右カラムに `.preview-container` が表示される
- [x] `.preview-container` 内に canvas 要素が存在する

### BlockEditorUI - 標準ブロック

- [x] 標準ブロック選択時、テクスチャスロット7つが表示される
- [x] テクスチャスロットクリックでテクスチャ選択モーダルが表示される
- [x] テクスチャ変更が3Dプレビューに反映される
- [x] 背景色ボタンクリックで背景色が変化する

### BlockEditorUI - カスタムブロック

- [x] カスタムブロック選択時、マテリアルスロット3つが表示される
- [x] モード切替ボタンが表示される
- [x] ブラシサイズボタン [4x][2x][1x] が表示される
- [x] マテリアルスロットクリックでマテリアルが選択される
- [x] マテリアルスロットダブルクリックでテクスチャ選択モーダルが表示される
- [x] ボクセル配置・削除が動作する

### BlockEditorUI - 当たり判定編集

- [x] モード切替ボタンクリックで当たり判定モードに切り替わる
- [x] 当たり判定モード時、ブラシサイズが [2x] 固定になる
- [x] 当たり判定モード時、自動作成ボタンが表示される
- [x] 自動作成ボタンクリックで当たり判定が自動生成される
- [x] 衝突テストボタンクリックでボールが落下する

### 新規ブロック作成

- [x] `.tile.add-new` クリックで `.create-modal` が表示される
- [x] 正常に入力して作成ボタンクリックで新規ブロックが作成される

### ブロック保存・削除

- [x] 保存ボタンクリックでデータが保存される
- [x] 削除ボタンクリックで確認モーダルが表示される
- [x] 確認後、ブロックが削除される

### テクスチャ一覧画面

- [x] テクスチャ一覧が表示される
- [x] テクスチャ選択時、詳細が表示される
- [x] 代表色を変更して保存できる
- [x] テクスチャを削除できる
