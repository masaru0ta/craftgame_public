# 仕様書: 1-6 ブロック形状一覧の表示と編集

## 1. 概要

ブロック形状一覧を表示し、標準ブロック・カスタムブロックの編集ができる統合管理ツールを作る。
1-3（標準ブロックエディタ）、1-4/1-5（カスタムブロックエディタ）の機能を1つの画面から利用できるようにする。

主な機能:
- ブロック形状一覧のグリッド表示（サムネイル付き）
- ブロック形状ごとの基本情報の編集
- ブロック形状（テクスチャ・カスタムブロック・当たり判定）の編集
- テクスチャの編集

src/test/ 及び src/game/ のディレクトリは公開用の Github リポジトリにプッシュする
公開用リポジトリ: https://github.com/masaru0ta/craftgame_public

## 2. 関連資料

- spec_1-1_block_data_sheet.md: データ構造
- spec_1-2_gas_api.md: API仕様
- src/game/gas_api.js
- src/game/standard_block_editor.js
- src/game/custom_block_editor.js
- docs/mockups/mockup_1-6_block_shape_manager.html: レイアウト確認用モックアップ

## 3. 機能詳細

### 3.1 画面構成

#### 3.1.1 全体構成

- 画面上部にタブバー（「ブロック一覧」「テクスチャ一覧」）
- タブ切り替えでメインコンテンツが切り替わる

#### 3.1.2 ブロック状態一覧画面

3カラム構成（比率 3:2:5）

**左カラム: ブロック一覧グリッド**
- ブロックをタイル形式でグリッド表示
- 各タイルにサムネイル画像（48x48px）と表示名
- 選択中のタイルはハイライト表示
- 最後に「+ 新規追加」タイル（破線枠）

**中央カラム: 基本情報**
- 見出し「基本情報」
- フォーム項目:
  - ブロックID（block_str_id）: テキスト入力、必須
  - 表示名（name）: テキスト入力、必須
  - ブロックタイプ（shape_type）: プルダウン（通常ブロック / カスタムブロック）
  - ドロップアイテム（drop_item）: テキスト入力
  - 発光レベル（light_level）: 数値入力（0-15）
  - オプション:
    - 透過ブロック（is_transparent）: チェックボックス
- ボタン行: 「削除」ボタン（赤）、「保存」ボタン（青）

**右カラム: 3Dプレビュー枠**
- アスペクト比 横:縦 = 3:4 の黒い枠
- カラム横幅いっぱいに表示
- 通常ブロック時: 標準ブロックエディタ（spec_1-3）の3Dプレビューを表示
- カスタムブロック時: カスタムブロックエディタ（spec_1-4, spec_1-5）の3Dプレビューを表示
- 既存エディタのJavaScriptクラスをインポートしてインスタンス化する

#### 3.1.3 テクスチャ一覧画面

2カラム構成（比率 7:3）

**左カラム: テクスチャ一覧**
- 見出し「テクスチャ一覧」
- テクスチャをタイル形式でグリッド表示
- 各タイルにサムネイル画像、テクスチャID、ファイル名
- 選択中のタイルはハイライト表示

**右カラム: テクスチャ詳細**
- 見出し「テクスチャ詳細」
- プレビュー画像（100x100px）
- フォーム項目:
  - テクスチャID（texture_id）: 数値表示、読み取り専用
  - ファイル名（file_name）: テキスト表示、読み取り専用
  - 代表色（color_hex）: カラーピッカー + テキスト入力
- ボタン行: 「削除」ボタン（赤）、「保存」ボタン（青）

#### 3.1.4 テクスチャ選択モーダル

テクスチャスロット/マテリアルスロットをクリック時に表示:
- モーダルヘッダー「テクスチャを選択」と閉じるボタン
- テクスチャ一覧をグリッド表示（4列）
- 各アイテムにサムネイルとファイル名

### 3.2 新規ブロック作成

#### 3.2.1 新規作成モーダル

「新規作成」ボタンクリックで表示されるモーダル:
- block_str_id 入力欄（必須、英数字とアンダースコアのみ）
- name 入力欄（必須）
- shape_type 選択（「標準」/「カスタム」ラジオボタン）
- 「作成」ボタン
- 「キャンセル」ボタン

#### 3.2.2 新規作成処理

1. 入力バリデーション
   - block_str_id が空でないこと
   - block_str_id が既存のブロックと重複しないこと
   - block_str_id が英数字とアンダースコアのみで構成されること
   - name が空でないこと
2. GAS API で新規ブロックを作成
3. 作成成功後、一覧が更新され新規ブロックが選択状態になる

### 3.3 ブロック編集

#### 3.3.1 ブロック選択

ページ読み込み時、ブロック一覧の先頭（block_id が最小）を自動選択する。

左カラムのタイルをクリックすると:
- 選択状態になりハイライト表示される
- 中央カラムに選択したブロックの基本情報が表示される
- 右カラムの3Dプレビュー枠に選択したブロックが表示される

未保存の変更がある状態で別のブロックを選択した場合:
- 「変更が保存されていません。破棄しますか？」確認ダイアログを表示
- 「OK」で変更を破棄して選択を切り替え
- 「キャンセル」で選択を維持

#### 3.3.2 ブロックタイプ変更

ブロックタイプ（通常ブロック ↔ カスタムブロック）を変更した場合:
- 「ブロックタイプを変更すると関連データがクリアされます。よろしいですか？」確認ダイアログを表示
- 「OK」で shape_type を変更し、関連データをクリア:
  - 通常→カスタム: tex_default, tex_top, tex_bottom, tex_front, tex_back, tex_left, tex_right をクリア
  - カスタム→通常: voxel_look, voxel_collision, material_1, material_2, material_3 をクリア
- 「キャンセル」で変更を取り消し

#### 3.3.3 保存時のバリデーション

保存ボタンクリック時に以下をチェック:
- block_str_id が空でないこと
- block_str_id が英数字とアンダースコアのみで構成されること
- block_str_id が他のブロックと重複しないこと（自身を除く）
- name が空でないこと

バリデーションエラー時はエラーメッセージを表示し、保存を中止する。

### 3.4 ブロック削除

#### 3.4.1 削除確認モーダル

削除ボタンクリックで確認モーダルを表示:
- 「[block_str_id] を削除しますか？」メッセージ
- 「削除」ボタン（赤色）
- 「キャンセル」ボタン

#### 3.4.2 削除処理

1. GAS API でブロックを削除
2. 削除成功後、一覧を更新

### 3.5 テクスチャ削除

#### 3.5.1 削除確認モーダル

削除ボタンクリックで確認モーダルを表示:
- 「[file_name] を削除しますか？」メッセージ
- 「削除」ボタン（赤色）
- 「キャンセル」ボタン

#### 3.5.2 削除処理

1. GAS API でテクスチャを削除
2. 削除成功後、一覧を更新

### 3.6 サムネイル生成

#### 3.6.1 標準ブロックのサムネイル

- default テクスチャを FRONT 面として使用
- テクスチャが未設定の場合はグレーの正方形

#### 3.6.2 カスタムブロックのサムネイル

- オフスクリーン Three.js レンダラーでプレビュー画像を生成
- カメラ位置: FRONT正面、垂直角度20度、距離3
- 背景: 透明
- サイズ: 128x128px

## 4. ファイル構成

```
src/
  tool/
    block_manager.html            # 一覧画面HTML
    block_manager_style.css       # 共通スタイル
    block_manager_main.js         # 一覧画面スクリプト
  game/
    block_thumbnail.js            # サムネイル生成ライブラリ
```

既存ファイルの変更:
- src/gas/script.js: createBlock アクション追加（spec_1-2_gas_api.md 参照）

## 5. 補足仕様

### 5.1 サムネイルのキャッシュ

- ブロック一覧取得時にサムネイルをキャッシュ
- ブロック更新時にキャッシュを無効化
- メモリ内キャッシュのみ（永続化なし）

### 5.2 一覧のソート

- デフォルトは block_id 昇順
- 将来的にソート切り替え機能を追加予定（本仕様では実装しない）

### 5.3 ページング

- 本仕様では実装しない（全件表示）
- ブロック数が増えた場合は将来対応

### 5.4 レスポンシブ対応

グリッド列数の変更:
- 幅 1200px 以上: 4列
- 幅 900px 以上: 3列
- 幅 600px 以上: 2列
- 幅 600px 未満: 1列

### 5.5 エラーハンドリング

- API通信エラー時はエラーメッセージを表示
- 削除失敗時は「削除に失敗しました」メッセージ
- 作成失敗時は「作成に失敗しました」メッセージ

## 6. テスト用CSSセレクタ定義

| 要素 | セレクタ | 検証内容 |
|------|----------|----------|
| タブバー | `.tabs` | タブ切り替え |
| タブ | `.tab` | ブロック一覧/テクスチャ一覧 |
| アクティブタブ | `.tab.active` | 選択中のタブ |
| メインコンテンツ | `.main` | タブに対応するコンテンツ |
| アクティブコンテンツ | `.main.active` | 表示中のコンテンツ |
| 左カラム | `.col-left` | ブロック一覧グリッド |
| 中央カラム | `.col-mid` | 基本情報フォーム |
| 右カラム | `.col-right` | 3Dプレビュー枠 |
| テクスチャ左カラム | `.col-7` | テクスチャ一覧（flex: 7） |
| テクスチャ右カラム | `.col-3` | テクスチャ詳細（flex: 3） |
| グリッド | `.grid` | タイルのグリッド表示 |
| タイル | `.tile` | 各ブロック/テクスチャのタイル |
| 選択中タイル | `.tile.selected` | 選択状態（background: #e3f2fd, border-color: #4285f4） |
| タイルサムネイル | `.tile-img` | サムネイル画像（48x48px） |
| タイル名前 | `.tile-name` | 表示名 |
| タイルID | `.tile-id` | テクスチャID表示 |
| 新規追加タイル | `.tile.add-new` | 新規追加ボタン（border: 2px dashed #aaa） |
| 3Dプレビュー枠 | `.preview-container` | 3Dプレビュー領域 |
| 保存ボタン | `.btn-primary` | 保存処理（background: #4285f4） |
| 削除ボタン | `.btn-danger` | 削除処理（color: #d93025, border-color: #d93025） |
| 確認モーダル | `.confirm-modal` | 確認ダイアログ（カスタムモーダル） |
| 確認モーダル実行ボタン | `.confirm-modal .btn-ok` | 確認モーダルの「OK」「削除」ボタン |
| 確認モーダルキャンセル | `.confirm-modal .btn-cancel` | 確認モーダルの「キャンセル」ボタン |
| 新規作成モーダル | `.create-modal` | 新規作成フォーム |
| 新規作成実行ボタン | `.create-modal .btn-ok` | 新規作成モーダルの「作成」ボタン |
| 新規作成キャンセル | `.create-modal .btn-cancel` | 新規作成モーダルの「キャンセル」ボタン |
| テクスチャ選択モーダル | `.picker-overlay` | テクスチャ選択ポップアップ |
| テクスチャ選択グリッド | `.picker-grid` | テクスチャ選択モーダル内グリッド |
| エラーメッセージ | `.error-message` | フォームエラー表示（color: #d93025） |
| 成功メッセージ | `.success-message` | 保存完了メッセージ（color: #1e8e3e） |
| フォームグループ | `.form-group` | フォーム項目のコンテナ |
| 必須マーク | `.required` | 必須項目の * マーク（color: #d93025） |

## 7. テスト項目

### 全体構成

- [x] Github にパブリッシュした画面が正常に表示される
- [x] 画面上部にタブバー（「ブロック一覧」「テクスチャ一覧」）が表示される
- [x] タブクリックでメインコンテンツが切り替わる
- [x] ページ読み込み後、ブロック一覧に `.tile` が1つ以上表示される
- [x] テクスチャ一覧タブに切り替え後、`.tile` が1つ以上表示される

### ブロック状態一覧画面 - レイアウト

- [x] `.col-left`、`.col-mid`、`.col-right` の3カラムが表示される
- [x] 中央カラムに見出し「基本情報」が表示される
- [x] 右カラムに `.preview-container` が表示される

### ブロック状態一覧画面 - 左カラム

- [x] `.grid` 内に `.tile` がグリッド表示される
- [x] 各タイルに `.tile-img` と `.tile-name` が表示される
- [x] ページ読み込み時、先頭のタイルに `.selected` クラスが付与される
- [x] タイルクリックで `.selected` クラスが付与される
- [x] タイル選択時、中央カラムのフォームに選択ブロックの値が表示される
- [x] フォーム値を変更後、別タイルを選択すると `.confirm-modal` が表示される
- [x] `.confirm-modal .btn-ok` クリックで選択が切り替わる
- [x] `.confirm-modal .btn-cancel` クリックで `.confirm-modal` が閉じ選択が維持される
- [x] 最後に `.tile.add-new` が表示される

### ブロック状態一覧画面 - 中央カラム

- [x] block_str_id 入力欄（input[type="text"]）が表示される
- [x] name 入力欄（input[type="text"]）が表示される
- [x] shape_type プルダウン（select）が表示される
- [x] shape_type プルダウン変更時に `.confirm-modal` が表示される
- [x] `.confirm-modal .btn-ok` クリックでプルダウンの値が変更される
- [x] `.confirm-modal .btn-cancel` クリックでプルダウンの値が元に戻る
- [x] drop_item 入力欄が表示される
- [x] light_level 数値入力（input[type="number"], min=0, max=15）が表示される
- [x] is_transparent チェックボックスが表示される
- [x] `.btn-danger`（削除）と `.btn-primary`（保存）ボタンが表示される

### ブロック状態一覧画面 - 右カラム（3Dプレビュー枠）

- [x] `.preview-container` が表示される
- [x] `.preview-container` 内に canvas 要素が存在する

### 新規ブロック作成

- [x] `.tile.add-new` クリックで `.create-modal` が表示される
- [x] モーダルに block_str_id 入力欄が表示される
- [x] モーダルに name 入力欄が表示される
- [x] モーダルに shape_type 選択（ラジオボタン）が表示される
- [x] `.create-modal .btn-ok` と `.create-modal .btn-cancel` が表示される
- [x] block_str_id が空で `.btn-ok` クリック時、`.error-message` が表示される
- [x] block_str_id に先頭ブロックと同じ値を入力して `.btn-ok` クリック時、`.error-message` が表示される
- [x] block_str_id に記号を入力して `.btn-ok` クリック時、`.error-message` が表示される
- [x] name が空で `.btn-ok` クリック時、`.error-message` が表示される
- [x] 正常に入力して `.btn-ok` クリックで `.create-modal` が閉じる
- [x] 作成成功後、`.grid` 内の `.tile` 数が増加する
- [x] 作成成功後、新規ブロックのタイルに `.selected` が付与される
- [x] `.create-modal .btn-cancel` クリックで `.create-modal` が閉じる

### ブロック保存

- [x] block_str_id を空にして `.btn-primary` クリック時、`.error-message` が表示される
- [x] block_str_id に記号を入力して `.btn-primary` クリック時、`.error-message` が表示される
- [x] block_str_id を別ブロックと同じ値にして `.btn-primary` クリック時、`.error-message` が表示される
- [x] name を空にして `.btn-primary` クリック時、`.error-message` が表示される
- [x] 正常な値で `.btn-primary` クリック時、`.success-message` が表示される

### ブロック削除

- [x] `.btn-danger` クリックで `.confirm-modal` が表示される
- [x] 確認モーダルに削除対象の block_str_id が含まれるメッセージが表示される
- [x] `.confirm-modal .btn-ok` と `.confirm-modal .btn-cancel` が表示される
- [x] `.confirm-modal .btn-ok` クリックで `.confirm-modal` が閉じる
- [x] 削除成功後、`.grid` 内の `.tile` 数が減少する
- [x] `.confirm-modal .btn-cancel` クリックで `.confirm-modal` が閉じる

### テクスチャ一覧画面 - レイアウト

- [x] `.col-7` と `.col-3` の2カラムが表示される
- [x] 左カラムに見出し「テクスチャ一覧」が表示される
- [x] 右カラムに見出し「テクスチャ詳細」が表示される

### テクスチャ一覧画面 - 左カラム

- [x] `.grid` 内に `.tile` がグリッド表示される
- [x] 各タイルに `.tile-img`、`.tile-id`、`.tile-name` が表示される
- [x] タイルクリックで `.selected` クラスが付与される

### テクスチャ一覧画面 - 右カラム

- [x] プレビュー画像が表示される
- [x] texture_id 入力欄（readonly）が表示される
- [x] file_name 入力欄（readonly）が表示される
- [x] color_hex 入力欄（input[type="color"] と input[type="text"]）が表示される
- [x] `.btn-danger`（削除）と `.btn-primary`（保存）ボタンが表示される

### テクスチャ保存

- [x] color_hex を変更して `.btn-primary` クリックで `.success-message` が表示される

### テクスチャ削除

- [x] `.btn-danger` クリックで `.confirm-modal` が表示される
- [x] 確認モーダルに削除対象の file_name が含まれるメッセージが表示される
- [x] `.confirm-modal .btn-ok` と `.confirm-modal .btn-cancel` が表示される
- [x] `.confirm-modal .btn-ok` クリックで `.confirm-modal` が閉じる
- [x] 削除成功後、`.grid` 内の `.tile` 数が減少する
- [x] `.confirm-modal .btn-cancel` クリックで `.confirm-modal` が閉じる
